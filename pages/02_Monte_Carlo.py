"""
pages/02_Monte_Carlo.py

Show aggregated Monte Carlo simulation outputs (champion odds, reach-round odds,
group-stage expectations).

Inputs:
- data/processed/montecarlo/mc_champion_odds.csv
- data/processed/montecarlo/mc_reach_round_odds.csv
- data/processed/montecarlo/mc_group_stage_expectations.csv
  (produced by: python run_monte_carlo.py --nsims 1000) [file:729][file:726]

Outputs:
- Interactive tables to explore simulation-derived probabilities and expectations.
"""

import os

import pandas as pd
import streamlit as st

from config import DATA_PROCESSED_MONTE_CARLO  # [file:726]


@st.cache_data
def _read_csv(path: str) -> pd.DataFrame:
    """Read a CSV with Streamlit caching for speed."""
    return pd.read_csv(path)


def _sort_by_prob(df: pd.DataFrame) -> pd.DataFrame:
    """
    Sort by the most common probability column used in this project.

    run_monte_carlo.py currently writes `pwin` (champion + reach files). [file:729]
    Some parts of the pipeline may rename to `p_win`, so support both.
    """
    if "p_win" in df.columns:
        return df.sort_values("p_win", ascending=False)
    if "pwin" in df.columns:
        return df.sort_values("pwin", ascending=False)
    return df


def main() -> None:
    st.title("Monte Carlo Simulation")

    st.write(
        "These tables are generated by the Monte Carlo runner. "
        "If they are missing, run: python run_monte_carlo.py --nsims 1000"
    )

    champ_path = os.path.join(DATA_PROCESSED_MONTE_CARLO, "mc_champion_odds.csv")
    reach_path = os.path.join(DATA_PROCESSED_MONTE_CARLO, "mc_reach_round_odds.csv")
    group_path = os.path.join(DATA_PROCESSED_MONTE_CARLO, "mc_group_stage_expectations.csv")

    col1, col2 = st.columns(2)

    with col1:
        st.subheader("Champion odds")
        if os.path.exists(champ_path):
            champ = _read_csv(champ_path)
            champ = _sort_by_prob(champ)
            st.dataframe(champ.head(25), use_container_width=True)
        else:
            st.info(f"Missing file: {champ_path}")

    with col2:
        st.subheader("Reach-round probabilities")
        if os.path.exists(reach_path):
            reach = _read_csv(reach_path)
            reach = _sort_by_prob(reach)
            st.dataframe(reach.head(25), use_container_width=True)
        else:
            st.info(f"Missing file: {reach_path}")

    st.subheader("Group-stage expectations")
    if os.path.exists(group_path):
        group = _read_csv(group_path)
        # run_monte_carlo sorts by pts/gd/gf already, but keep a safe fallback.
        if "pts" in group.columns:
            group = group.sort_values("pts", ascending=False)
        st.dataframe(group.head(30), use_container_width=True)
    else:
        st.info(f"Missing file: {group_path}")


if __name__ == "__main__":
    main()