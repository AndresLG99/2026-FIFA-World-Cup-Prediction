"""
reports/make_figures.py

Create plots for the report / web app.

Inputs:
- reports/tables/*.csv  (generated by src.metrics.build_report_tables)

Outputs:
- reports/figures/*.png

Design goal:
- Keep plots simple, readable, and web-friendly.
- Plot scripts should NOT depend on data/processed directly.
"""

import os

import pandas as pd
import matplotlib.pyplot as plt

from config import REPORTS_DIR


def _report_dirs() -> dict:
    """
    Resolve report subfolders.
    Creates /reports/figures if it doesn't exist.
    """
    tables_dir = os.path.join(REPORTS_DIR, "tables")
    figures_dir = os.path.join(REPORTS_DIR, "figures")
    os.makedirs(figures_dir, exist_ok=True)
    return {"tables": tables_dir, "figures": figures_dir}


def _safe_read_table(path: str) -> pd.DataFrame | None:
    """
    Read a table if it exists; otherwise return None.

    Why:
    - Allows running plotting even when some tables haven't been generated yet.
    - Keeps this script from crashing mid-way through figure generation.
    """
    if not os.path.exists(path):
        print(f"[make_figures] Missing table (skipping): {path}")
        return None
    return pd.read_csv(path)


def plot_champion_odds_top15() -> None:
    """
    Horizontal bar chart: champion odds (Top 15).

    Input table:
    - reports/tables/champion_odds_top15.csv
      Columns: team, pwin (or champion, p_win depending on your table builder)
    """
    d = _report_dirs()
    path = os.path.join(d["tables"], "champion_odds_top15.csv")
    df = _safe_read_table(path)
    if df is None or df.empty:
        return

    # Support either schema:
    # - (team, pwin) from report tables
    # - (champion, p_win) if you ever point directly at MC output
    if "team" in df.columns and "pwin" in df.columns:
        team_col, p_col = "team", "pwin"
    elif "champion" in df.columns and "p_win" in df.columns:
        team_col, p_col = "champion", "p_win"
    else:
        raise ValueError(f"Unexpected columns in {path}: {df.columns.tolist()}")

    df = df.sort_values(p_col, ascending=True).copy()

    plt.figure(figsize=(10, 6))
    plt.barh(df[team_col], df[p_col])
    plt.xlabel("Probability")
    plt.title("2026 World Cup Champion Odds (Top 15)")
    plt.tight_layout()

    out = os.path.join(d["figures"], "champion_odds_top15.png")
    plt.savefig(out, dpi=200)
    plt.close()


def plot_reach_round_odds_focus() -> None:
    """
    Line chart: probability of reaching each round for selected teams.

    Input table:
    - reports/tables/reach_round_odds_focus.csv
      Columns (expected): team, reached_R32, reached_R16, reached_QF, reached_SF, reached_FINAL, pwin
    """
    d = _report_dirs()
    path = os.path.join(d["tables"], "reach_round_odds_focus.csv")
    df = _safe_read_table(path)
    if df is None or df.empty:
        return

    stage_cols = [c for c in ["reached_R32", "reached_R16", "reached_QF", "reached_SF", "reached_FINAL", "pwin"] if c in df.columns]
    if "team" not in df.columns or not stage_cols:
        raise ValueError(f"Unexpected columns in {path}: {df.columns.tolist()}")

    long = df.melt(id_vars="team", value_vars=stage_cols, var_name="stage", value_name="prob")

    # Stable order (use pwin if present; otherwise use deepest available)
    order_col = "pwin" if "pwin" in df.columns else stage_cols[-1]
    team_order = df.sort_values(order_col, ascending=False)["team"].tolist()

    plt.figure(figsize=(11, 6))
    for team in team_order:
        sub = long[long["team"] == team].copy()
        plt.plot(sub["stage"], sub["prob"], marker="o", linewidth=2, label=team)

    plt.xlabel("Stage")
    plt.ylabel("Probability")
    plt.title("Probability of Reaching Each Round (Selected Teams)")
    plt.xticks(rotation=25, ha="right")
    plt.ylim(0.0, 1.05)
    plt.legend(fontsize=8, ncol=2)
    plt.tight_layout()

    out = os.path.join(d["figures"], "reach_round_odds_focus.png")
    plt.savefig(out, dpi=200)
    plt.close()


def plot_group_stage_expected_points_top15() -> None:
    """
    Horizontal bar chart: expected group-stage points (Top 15).

    Input table:
    - reports/tables/group_stage_expectations_top15.csv
      Columns: team, pts (and maybe gd, gf, ga, rank_in_group)
    """
    d = _report_dirs()
    path = os.path.join(d["tables"], "group_stage_expectations_top15.csv")
    df = _safe_read_table(path)
    if df is None or df.empty:
        return

    if "team" not in df.columns or "pts" not in df.columns:
        raise ValueError(f"Unexpected columns in {path}: {df.columns.tolist()}")

    df = df.sort_values("pts", ascending=True).copy()

    plt.figure(figsize=(10, 6))
    plt.barh(df["team"], df["pts"])
    plt.xlabel("Expected points (group stage)")
    plt.title("Group Stage Expected Points (Top 15)")
    plt.tight_layout()

    out = os.path.join(d["figures"], "group_stage_expected_points_top15.png")
    plt.savefig(out, dpi=200)
    plt.close()


def plot_model_mae_worldcups() -> None:
    """
    Line chart: MAE (total goals) on World Cup holdout years for both models.

    Input table:
    - reports/tables/model_mae_worldcups.csv
      Columns: model, year, mae_total (plus mae_home, mae_away, n)
    """
    d = _report_dirs()
    path = os.path.join(d["tables"], "model_mae_worldcups.csv")
    df = _safe_read_table(path)
    if df is None or df.empty:
        return

    required = {"model", "year", "mae_total"}
    if not required.issubset(set(df.columns)):
        raise ValueError(f"Unexpected columns in {path}: {df.columns.tolist()}")

    plt.figure(figsize=(9, 5))
    for model in sorted(df["model"].unique()):
        sub = df[df["model"] == model].sort_values("year")
        plt.plot(sub["year"], sub["mae_total"], marker="o", linewidth=2, label=model)

    plt.xlabel("World Cup year")
    plt.ylabel("MAE (total goals per match)")
    plt.title("Model Error on World Cup Holdout Years")
    plt.legend()
    plt.tight_layout()

    out = os.path.join(d["figures"], "model_mae_worldcups.png")
    plt.savefig(out, dpi=200)
    plt.close()


def main() -> None:
    """
    Generate all report figures.
    Safe to run repeatedly.
    """
    plot_champion_odds_top15()
    plot_reach_round_odds_focus()
    plot_group_stage_expected_points_top15()
    plot_model_mae_worldcups()

    print(f"Saved figures to: {os.path.join(REPORTS_DIR, 'figures')}")


if __name__ == "__main__":
    main()